unit UPedidoServiceImpl;

interface

uses
  UPedidoServiceIntf, UPizzaTamanhoEnum, UPizzaSaborEnum,
  UPedidoRepositoryIntf, UPedidoRetornoDTOImpl, UClienteServiceIntf,TypInfo;

type
  TPedidoService = class(TInterfacedObject, IPedidoService)
  private
    FPedidoRepository: IPedidoRepository;
    FClienteService: IClienteService;

    function calcularValorPedido(const APizzaTamanho: TPizzaTamanhoEnum): Currency;
    function calcularTempoPreparo(const APizzaTamanho: TPizzaTamanhoEnum; const APizzaSabor: TPizzaSaborEnum): Integer;
  public
    function efetuarPedido(const APizzaTamanho: TPizzaTamanhoEnum; const APizzaSabor: TPizzaSaborEnum; const ADocumentoCliente: String): TPedidoRetornoDTO;
    function GetPedido(const ADocumentoCliente: string): TPedidoRetornoDTO; stdcall;
    constructor Create; reintroduce;

  end;

implementation

uses
  UPedidoRepositoryImpl, System.SysUtils, UClienteServiceImpl,
  FireDAC.Comp.Client, DATA.DB;

{ TPedidoService }

function TPedidoService.calcularTempoPreparo(const APizzaTamanho: TPizzaTamanhoEnum; const APizzaSabor: TPizzaSaborEnum): Integer;
begin
  Result := 15;
  case APizzaTamanho of
    enPequena:
      Result := 15;
    enMedia:
      Result := 20;
    enGrande:
      Result := 25;
  end;

  if (APizzaSabor = enPortuguesa) then
    Result := Result + 5;
end;

function TPedidoService.calcularValorPedido(const APizzaTamanho: TPizzaTamanhoEnum): Currency;
begin
  Result := 20;
  case APizzaTamanho of
    enPequena:
      Result := 20;
    enMedia:
      Result := 30;
    enGrande:
      Result := 40;
  end;
end;

constructor TPedidoService.Create;
begin
  inherited;

  FPedidoRepository := TPedidoRepository.Create;
  FClienteService := TClienteService.Create;
end;

function TPedidoService.efetuarPedido(const APizzaTamanho: TPizzaTamanhoEnum; const APizzaSabor: TPizzaSaborEnum; const ADocumentoCliente: String)
  : TPedidoRetornoDTO;
var
  oValorPedido: Currency;
  oTempoPreparo: Integer;
  oCodigoCliente: Integer;
begin
  oValorPedido := calcularValorPedido(APizzaTamanho);
  oTempoPreparo := calcularTempoPreparo(APizzaTamanho, APizzaSabor);
  oCodigoCliente := FClienteService.adquirirCodigoCliente(ADocumentoCliente);

  FPedidoRepository.efetuarPedido(APizzaTamanho, APizzaSabor, oValorPedido, oTempoPreparo, oCodigoCliente);
  Result := TPedidoRetornoDTO.Create(APizzaTamanho, APizzaSabor, oValorPedido, oTempoPreparo);
end;

function TPedidoService.GetPedido(
  const ADocumentoCliente: string): TPedidoRetornoDTO;
var
  oFDQuery:TFDQuery;
  var ENUMTAMANHO: TPizzaTamanhoEnum;
  var ENUMSABOR: TPizzaSaborEnum;
  VAR STRTAMANHO: TPizzaTamanhoEnum;
  VAR STRSABOR: TPizzaSaborEnum;
begin

  oFDQuery:= TFDquery.create(nil);
  try
    FPedidoRepository.GetPedido(ADocumentoCliente, oFDQuery);
    If(oFDQuery.IsEmpty) then
      raise Exception.Create('O cliente com nro de documento '+ADocumentoCliente+' não possui pedido');
    //persistir o tamanho da pizza ao fazer o pedido
    //persistir o sabor da pizza ao fazer o pedido
    //OFDquery.FieldByName('tx_tamanhopizza').AsString,OFDquery.FieldByName('tx_saborpizza').AsString
    ENUMTAMANHO:=TPizzaTamanhoEnum(GetEnumValue(TypeInfo(TPizzaTamanhoEnum), OFDquery.FieldByName('tx_tamanhopizza').AsString));
    ENUMSABOR:=TPizzaSaborEnum(GetEnumValue(TypeInfo(TPizzaSaborEnum), OFDquery.FieldByName('tx_saborpizza').AsString));

    STRTAMANHO:=enMedia;
    STRSABOR:=enCalabresa;

    Result:= TPedidoRetornoDTO.Create(ENUMTAMANHO,STRSABOR,OFDquery.FieldByName('vl_pedido').AsCurrency,OFDquery.FieldByName('nr_tempopedido').AsInteger);
  finally
    oFDQuery.free;
  end;

end;

end.
